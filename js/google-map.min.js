var app=angular.module("google-maps",[]);
app.service("markers",["$rootScope","$http","options",function(a,d,b){this.loadMarkers=function(a,e){var f=this;d.get(a,{params:e}).success(function(a){f.parseMarkers(a);console.log(a)})};this.parseMarkers=function(a){var e=this;angular.forEach(a,function(a,c){var d=new google.maps.Marker({position:new google.maps.LatLng(a.latitude||a.lat,a.longitude||a.lng),icon:b.getOptions().markerImage,animation:google.maps.Animation.DROP,title:a.title||a.name,data:a});e.addMarker(d,c)})};this.addMarker=function(c,
e){a.$broadcast("marker.add",c,e);a.markers.push(c)};this.getMarkers=function(){return a.markers};this.getMarkerById=function(c){return a.markers.filter(function(a){return a.data&&a.data.geonameId.toString()===c})}}]);
app.service("options",["$rootScope",function(a){this.getOptions=function(){return{mainBounds:new google.maps.LatLngBounds,mapDefaults:{zoom:7,center:new google.maps.LatLng("33.815556","-117.889723"),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,scaleControl:!1,navigationControl:!1,scrollwheel:!1},markerImage:null,polyLineOptions:{strokeColor:"#4588f7",strokeOpacity:1,strokeWeight:5,map:a.map},circleOptions:{strokeColor:"#4588f7",strokeOpacity:0.5,strokeWeight:2,fillColor:"#4588f7",fillOpacity:0.2,
map:a.map,radius:5E3},panoramaOptions:{addressControlOptions:{position:google.maps.ControlPosition.TOP_LEFT},linksControl:!1,panControl:!0,zoomControl:!1,enableCloseButton:!1}}}}]);
app.service("map",["$rootScope","$http","$q","$window",function(a,d,b,c){this.offSetMap=function(e){if(a.offset){var f=c.outerWidth;991<f?a.map.panToWithOffset(e,-(f/a.offset),0):a.map.panTo(e)}else a.map.panTo(e)};this.extendMapPrototype=function(){google.maps.Map.prototype.panToWithOffset=function(a,c,b){var d=this,l=new google.maps.OverlayView;l.onAdd=function(){var l=this.getProjection(),h=l.fromLatLngToContainerPixel(a);h.x+=c;h.y+=b;d.panTo(l.fromContainerPixelToLatLng(h))};l.draw=function(){};
l.setMap(this)}};this.apply=function(){a.$apply()};this.geocoder=function(){return new google.maps.Geocoder};this.geo=function(){var a=this,c=b.defer();return{locate:function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){c.resolve(new google.maps.LatLng(b.coords.latitude,b.coords.longitude));a.apply()},function(){a.handleNoGeolocation(c);a.apply()}):(this.handleNoGeolocation(c),this.apply());return c.promise},code:function(b){console.log("geocode data",b);a.geocoder().geocode({address:b},
function(b,d){d===google.maps.GeocoderStatus.OK?c.resolve(b[0]):c.reject(d);a.apply()});return c.promise},distance:function(a,b){var e=google.maps.geometry.spherical.computeDistanceBetween(a,b);c.resolve((6.21371E-4*e).toFixed(2));return c.promise}}};this.handleNoGeolocation=function(a){d.get("http://ipinfo.io/json").success(function(c){c=c.loc.split(",",2);a.resolve(new google.maps.LatLng(c[0],c[1]))})};this.getDirections=function(){var c=this;return{directions:function(){var d=b.defer();(new google.maps.DirectionsService).route({origin:a.currentLocation.toUrlValue(),
destination:a.activeMarker.position.toUrlValue(),travelMode:google.maps.TravelMode.DRIVING},function(a,b){b===google.maps.DirectionsStatus.OK?d.resolve(a):d.reject(b);c.apply()});return d.promise}}};this.getStreetview=function(a){var c=this;return{streetview:function(){var d=b.defer();(new google.maps.StreetViewService).getPanoramaByLocation(a.position,50,function(a,b){b===google.maps.StreetViewStatus.OK?d.resolve(a):d.reject(b);c.apply()});return d.promise}}}}]);
app.controller("googleMap",function(a,d,b){a.markers=[];a.isVisible={};console.log("google maps is running");console.time("gmap render")});app.controller("geolocateService",function(a,d,b,c){d.$on("map.loaded",function(){b.geo().locate().then(function(b){console.log("geo complete");a.currentLocation=b;d.circle=new google.maps.Circle(c.getOptions().circleOptions);d.polyline=new google.maps.Polyline(c.getOptions().polyLineOptions);d.$emit("geo.complete")})})});
app.directive("googleMap",function(a,d,b,c){return{restrict:"A",controller:"googleMap",link:function(e,f,g){"true"===g.preload&&c.loadMarkers(g.url,g.params);b.extendMapPrototype();a.offset=g.offset?g.offset:!1;a.map=new google.maps.Map(f[0],d.getOptions().mapDefaults);a.infoWindow=new google.maps.InfoWindow;e.$broadcast("map.loaded");a.isVisible.Map=!0;google.maps.event.addDomListener(window,"resize",function(){a.map.setCenter(a.mapCenter)});google.maps.event.addListener(a.map,"idle",function(){console.log("map is idle");
a.mapCenter=a.map.getCenter();a.mapZoom=a.map.getZoom();console.timeEnd("marker click")});console.timeEnd("gmap render");a.$on("marker.add",function(c,d,e){e=e?e:1;c=function(c){return function(){d.setMap(a.map)}};google.maps.event.addListener(d,"click",function(){console.time("marker click");a.$apply(a.activeMarker=this);b.offSetMap(this.position);a.infoWindow.setContent(this.title);a.infoWindow.open(a.map,this)});"true"!=g.clusterMarkers?setTimeout(c(e),20*e):c(e)})}}});
app.directive("zoom",function(a){return{restrict:"A",link:function(d,b,c){b.on("click",function(b){b.preventDefault();"in"===c.zoom?a.map.setZoom(a.map.getZoom()+1):"out"===c.zoom&&a.map.setZoom(a.map.getZoom()-1)})}}});
app.directive("infowindow",function(a,d){return{restrict:"A",templateUrl:"/partials/map-infowindow.html",link:function(b,c,d){a.$watchCollection("markers",function(c){angular.forEach(c,function(c,b){google.maps.event.addListener(c,"click",function(){a.$apply(function(){a.isVisible.Infowindow=!0})})})})}}});
app.directive("directionService",function(a,d,b,c){return{restrict:"A",controller:"geolocateService",link:function(e,f,g){a.$watchCollection("markers",function(a,c){angular.forEach(a,function(a,c){google.maps.event.addListener(a,"click",function(){b.getDirections().directions().then(function(a){e.directions=a;e.polyline.setOptions({path:a.routes[0].overview_path})})})})});e.$on("geo.complete",function(){e.circle.setCenter(a.currentLocation);var b=new google.maps.Marker({position:a.currentLocation,
icon:d.getOptions().markerImage,animation:google.maps.Animation.DROP,title:"You are Here"});c.addMarker(b)})}}});app.directive("directionInfo",function(a){return{restrict:"A",templateUrl:"/partials/map-distanceinfo.html",link:function(a,b,c){}}});
app.directive("streetviewService",function(a,d,b){return{restrict:"A",link:function(c,e,f){a.$watchCollection("markers",function(e,f){angular.forEach(e,function(e,f){google.maps.event.addListener(e,"click",function(){b.getStreetview(this).streetview().then(function(b){c.$emit("streetview.success");a.map.getStreetView().setOptions(d.getOptions().panoramaOptions);a.map.getStreetView().setPano(b.location.pano);a.isVisible.StreetViewOpen=!0},function(b){c.$emit("streetview.fail");a.isVisible.StreetViewOpen=
!1})})})})}}});app.directive("streetViewOpen",function(a,d,b){return{restrict:"A",link:function(c,b,d){c.openStreetView=function(b){c.$emit("streetview.open");a.map.getStreetView().setVisible(!0);a.isVisible.Map=!1;a.isVisible.Infowindow=!1}}}});app.directive("streetViewClose",function(a,d,b){return{restrict:"A",link:function(c,b,d){c.closeStreetView=function(b){c.$emit("streetview.close");a.map.getStreetView().setVisible(!1);a.isVisible.Map=!0;a.isVisible.Infowindow=!0}}}});
app.directive("autoCompleteMap",function(a,d,b,c,e){return{restrict:"A",link:function(b,d,k){b.$watch(k.ngModel,function(d){d&&1<d.length&&(b.mapsearchresults=c("limitTo")(c("filter")(a.markers,{data:d},!1),10),a.mapactivesearchitem=null)});d.on("focus",function(){a.$apply(function(){a.focus=!0;a.isVisible.Infowindow=!1});a.$broadcast("mapsearch.focus")});d.on("blur",function(){a.$apply(function(){a.focus=!1;a.isVisible.Infowindow=!0});a.$broadcast("mapsearch.blur")});d.on("keydown",function(c){if(38===
c.which)if(c.preventDefault(),a.mapactivesearchitem&&0!=a.mapactivesearchitem.attr("tabindex")){var k=a.mapactivesearchitem[0].previousSibling;8!=k.nodeType?a.$apply(function(){a.mapactivesearchitem=angular.element(k)}):a.$apply(function(){a.mapactivesearchitem=angular.element(k.previousSibling)})}else a.$apply(function(){a.mapactivesearchitem=b.lastsearchitem});else 40===c.which?(c.preventDefault(),a.mapactivesearchitem&&a.mapactivesearchitem.attr("tabindex")!=b.mapsearchresults.length-1?a.$apply(function(){a.mapactivesearchitem=
a.mapactivesearchitem.next()}):a.$apply(function(){a.mapactivesearchitem=b.firstsearchitem})):13===c.which&&(c=e.getMarkerById(a.mapactivesearchitem.attr("id")),new google.maps.event.trigger(c[0],"click"),d.triggerHandler("blur"))});a.$watchCollection("markers",function(a,c){angular.forEach(a,function(a,c){google.maps.event.addListener(a,"click",function(){var a=this;this.data?b.$apply(function(){b.mapsearch=a.data.name}):b.$apply(function(){b.mapsearch="Your Location"})})})})}}});
app.directive("autoCompleteResultsMap",function(a,d,b,c){return{restrict:"A",templateUrl:"/partials/map-search-result.html",link:function(a,d,g){a.$watch("mapactivesearchitem",function(a,d){if(a!=d&&(d&&d.removeClass("active"),a)){var e=c.getMarkerById(a.attr("id"));b.offSetMap(e[0].position);a.addClass("active")}});a.$watch("mapsearchresults",function(c,b){if(c){var g=d.children();a.firstsearchitem=angular.element(g[0]);a.lastsearchitem=angular.element(g[g.length-1])}})}}});
app.directive("resultItemLocation",function(a,d,b,c){return{restrict:"A",link:function(b,d,g){b.setActiveSearchItem=function(c){a.mapactivesearchitem=d};d.on("mousedown",function(){var a=c.getMarkerById(g.id);new google.maps.event.trigger(a[0],"click")})}}});
app.directive("testLocationMarkers",function(a,d,b,c){return{restrict:"A",link:function(b,f,g){var k=0;b.spamMarkers=function(){var g=0;console.time("add markers timer");a.map.setZoom(5);for(var f=new google.maps.LatLng(40.744656,-74.005966),h=new google.maps.LatLng(34.052234,-118.243685),n=h.lng()-f.lng(),h=h.lat()-f.lat(),m=1E3*k;m<1E3*(k+1);m++){var p=new google.maps.Marker({position:new google.maps.LatLng(f.lat()+h*Math.random(),f.lng()+n*Math.random()),icon:d.getOptions().markerImage,animation:google.maps.Animation.DROP,
title:"Test Marker "+m,data:{geonameId:"tm"+m,name:"Test Marker "+m}});c.addMarker(p,g++)}k++;b.$emit("markers.added");console.timeEnd("add markers timer")}}}});app.directive("locationItems",function(a,d,b,c){return{restrict:"A",templateUrl:"/partials/map-location-items.html"}});
app.controller("filterLocationControl",function(a,d,b){b.regions=[{title:"All Locations",value:"*"},{title:"Yolo County",value:"Yolo County"},{title:"Los Angeles County",value:"Los Angeles County"},{title:"Orange County",value:"Orange County"}];b.locationfilter=function(a){if(a&&a.data){if(void 0===b.regionsfilter.value||0===b.regionsfilter.title.length||"*"===b.regionsfilter.value)return!0;var d=!1;angular.forEach(a,function(f){a.data.region===b.regionsfilter.value&&(d=!0)});return d}}});
app.directive("locationSelect",function(a,d,b,c){return{restrict:"A",controller:"filterLocationControl",require:"ngModel"}});app.directive("locationFilter",function(a,d,b,c){return{restrict:"A",controller:"filterLocationControl",templateUrl:"/partials/map-location-filter.html",link:function(a,b,c){a.addFilter=function(b){a.regionsfilter=b};a.regionsfilter=a.regions[0]}}});
app.directive("clusterMarkers",function(a,d,b){return{restrict:"A",link:function(b,d,f){b.$on("map.loaded",function(){b.markerCluster=new MarkerClusterer(a.map,a.markers)});b.$on("marker.add",function(a,d,e){b.markerCluster.addMarker(d)})}}});
app.directive("origin",function(a,d,b){return{restrict:"A",controller:"geolocateService",link:function(a,e,f){a.$on("map.loaded",function(){d.geo().code(f.origin).then(function(e){a.originInfo=e;a.originPos=new google.maps.LatLng(e.geometry.location.lat(),e.geometry.location.lng());a.$emit("origin.loaded");d.offSetMap(a.originPos);b.parseMarkers([{locationlatitude:e.geometry.location.lat(),locationlongitude:e.geometry.location.lng()}])},function(b){a.map.setZoom(3)})})}}});
app.directive("originInfo",function(a,d){return{restrict:"A",templateUrl:"/partials/map-origin-info.html",link:function(b,c,e){function f(){function a(){d.geo().distance(b.currentLocation,b.originPos).then(function(a,d){b.countryInfo.distance=a})}b.currentLocation&&b.originPos?a():b.$on("geo.complete",function(){a()})}function g(){a.get("https://www.googleapis.com/freebase/v1/topic/authority/iso/3166-1/alpha-3/"+b.countryInfo.isoAlpha3+"?filter=/common/topic/description").success(function(a,d){b.countryInfo.description=
a.property["/common/topic/description"].values[0];b.countryInfo.description.current=b.countryInfo.description.text;b.isVisible.originInfo=!0;f()})}b.$on("origin.loaded",function(){a.get("http://api.geonames.org/countryInfoJSON",{params:{country:b.originInfo.address_components[0].short_name,username:"beddaniel"}}).success(function(a,d){b.countryInfo=a.geonames[0];g()})})}}});
app.directive("moreInfo",function(){return{restrict:"A",link:function(a,d,b){a.moreInfoLabel="more";a.moreInfo=function(){"more"===a.moreInfoLabel?(a.countryInfo.description.current=a.countryInfo.description.value,a.moreInfoLabel="less"):(a.countryInfo.description.current=a.countryInfo.description.text,a.moreInfoLabel="more")}}}});
app.directive("staticMap",function(){return{restric:"A",link:function(a,d,b){a.$on("map.loaded",function(){a.map.setOptions({zoom:5,disableDefaultUI:!0,panControl:!1,draggable:!1,zoomControl:!1,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,overviewMapControl:!1,scrollwheel:!1})})}}});
app.directive("lazyload",function(a){return{restrict:"A",link:function(a,b,c){a.img=new Image;a.setStyle=function(a){"IMG"===b[0].nodeName?b[0].src=a:(b[0].style.backgroundImage="url("+a+")",b[0].style.backgroundSize="cover")};a.loadAdaptiveImg=function(){var b=a.getAdaptiveUrl();a.img.onload=function(){a.setStyle(b)};a.img.onerror=function(){a.loadDefaultImg()};a.img.src=b};a.loadDefaultImg=function(){var b=c.img;a.img.onload=function(){a.setStyle(b)};a.img.onerror=function(){throw Error("No img found, please check source");
};a.img.src=b};a.getAdaptiveUrl=function(){var a=window.outerWidth,b=c.img.split(".",2);return c.lazyload?c.img:768>a?b[0]+"-xs."+b[1]:992>a?b[0]+"-sm."+b[1]:1200>a?b[0]+"-md."+b[1]:c.img};a.loadAdaptiveImg()}}});
